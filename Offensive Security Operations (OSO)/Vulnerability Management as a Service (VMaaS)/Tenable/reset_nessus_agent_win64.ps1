# Windows 64-bit Nessus Agent Reset Script
$ServiceName = "Tenable Nessus Agent"

# Check if running as Administrator
$CurrentUser = [Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()
if (-NOT $CurrentUser.IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "This script must be run as Administrator."
    exit
}

try {
    Write-Host "Stopping Nessus Agent service..."
    Stop-Service -Name $ServiceName -Force
    Start-Sleep -Seconds 5

    # Check if service stopped successfully
    $service = Get-Service -Name $ServiceName -ErrorAction Stop
    if ($service.Status -eq "Stopped") {
        Write-Host "Nessus Agent service stopped successfully."

        # Navigate to Nessus Agent directory
        Set-Location -Path "C:\Program Files\Tenable\Nessus Agent"

        # Reset plugins
        Write-Host "Resetting Nessus Agent plugins..."
        .\nessuscli.exe plugins --reset

        # Verify plugins info
        Write-Host "Verifying Nessus Agent plugins..."
        .\nessuscli.exe plugins --info

        # Restart the Nessus Agent service
        Write-Host "Restarting Nessus Agent service..."
        Start-Service -Name $ServiceName

        # Confirm service status
        Get-Service -Name $ServiceName
        Write-Host "Nessus Agent reset and restarted successfully."
    } else {
        Write-Host "Failed to stop Nessus Agent service."
    }
} catch {
    Write-Host "An error occurred: $_"
    exit 1
}
