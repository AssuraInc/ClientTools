#!/bin/bash

SERVICE_NAME="com.tenablesecurity.nessusagent"
NESSUS_CLI="/Library/NessusAgent/run/sbin/nessuscli"

# Function to check if the script is run as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "This script must be run as root (or with sudo)."
        exit 1
    fi
}

# Function to stop the Nessus Agent
stop_agent() {
    echo "Stopping Nessus Agent service..."
    launchctl stop $SERVICE_NAME
    if [[ $? -ne 0 ]]; then
        echo "Failed to stop Nessus Agent service."
        exit 1
    fi
}

# Function to reset Nessus plugins
reset_plugins() {
    echo "Resetting Nessus Agent plugins..."
    if [[ -x $NESSUS_CLI ]]; then
        $NESSUS_CLI plugins --reset
        if [[ $? -ne 0 ]]; then
            echo "Plugin reset failed."
            exit 1
        fi
    else
        echo "Nessus CLI not found at $NESSUS_CLI"
        exit 1
    fi
}

# Function to start the Nessus Agent
start_agent() {
    echo "Starting Nessus Agent service..."
    launchctl start $SERVICE_NAME
    if [[ $? -ne 0 ]]; then
        echo "Failed to start Nessus Agent service."
        exit 1
    fi
    echo "Nessus Agent service restarted successfully."
}

# Main execution
check_root
stop_agent
reset_plugins
start_agent
